<!doctype html>
<html>
  <head>
    <title>YANG-XML Validator</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .file-input {
        margin: 15px 0;
      }
      button {
        padding: 10px 15px;
        background: #4caf50;
        color: white;
        border: none;
        cursor: pointer;
      }
      button:disabled {
        background: #cccccc;
      }
      #result {
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #ddd;
        min-height: 50px;
      }
      .error {
        color: #d32f2f;
      }
      .success {
        color: #388e3c;
      }
    </style>
  </head>
  <body>
    <h1>YANG-XML Validator</h1>
    <div class="file-input">
      <h3>Upload YANG Schema:</h3>
      <input type="file" id="yangFile" accept=".yang" />
    </div>
    <div class="file-input">
      <h3>Upload XML Configuration:</h3>
      <input type="file" id="xmlFile" accept=".xml" />
    </div>
    <button id="validateBtn" disabled>Validate</button>
    <div id="result"></div>

    <script src="validator.js"></script>
    <script>
      let Module;
      const validateBtn = document.getElementById("validateBtn");
      const resultDiv = document.getElementById("result");

      // Initialize WASM module
      Validator()
        .then(function (loadedModule) {
          Module = loadedModule;
          validateBtn.disabled = false;
          logMessage("WASM module loaded and ready");
        })
        .catch((err) => {
          logMessage(`Failed to load WASM module: ${err}`, true);
        });

      // Helper to read file content
      function readFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = reject;
          reader.readAsText(file);
        });
      }

      // Helper to display messages
      function logMessage(message, isError = false) {
        resultDiv.innerHTML = message;
        resultDiv.className = isError ? "error" : "success";
      }

      // Validation handler using only confirmed Module methods
      validateBtn.addEventListener("click", async () => {
        const yangFile = document.getElementById("yangFile").files[0];
        const xmlFile = document.getElementById("xmlFile").files[0];

        if (!yangFile || !xmlFile) {
          logMessage("Please upload both YANG and XML files", true);
          return;
        }

        try {
          logMessage("Validating...");

          const [yangContent, xmlContent] = await Promise.all([
            readFile(yangFile),
            readFile(xmlFile),
          ]);

          // Use ccall instead of direct memory manipulation
          const result = Module.ccall(
            "validate", // Function name
            "string", // Return type
            ["string", "string"], // Argument types
            [yangContent, xmlContent], // Arguments
          );

          // Display results
          const isError = result.toLowerCase().includes("error");
          logMessage(result, isError);
        } catch (error) {
          logMessage(`Validation failed: ${error.message}`, true);
          console.error(error);
        }
      });
    </script>
  </body>
</html>
